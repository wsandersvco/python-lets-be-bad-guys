name: Veracode Static Analysis - Upload And Scan
on: workflow_dispatch

jobs:
  build:
    name: Build
    uses: ./.github/workflows/build.yml
    with:
      name: veracode-artifact
      path: ./veracode_artifact_directory
    secrets: inherit

  policy_scan:
    name: Veracode Static Analysis - Policy Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v6
        with:
          name: veracode-artifact
          path: ./veracode_artifact_directory

      - name: Veracode Upload And Scan
        uses: veracode/veracode-uploadandscan-action@0.2.11
        with:
          appname: "GitHub Actions - python-lets-be-bad-guys"
          createprofile: true
          teams: "Default Team"
          deleteincompletescan: 1
          debug: false
          filepath: "./veracode_artifact_directory"
          vid: "${{ secrets.VERACODE_API_ID }}"
          vkey: "${{ secrets.VERACODE_API_KEY }}"
          # createsandbox: 'true'
          # sandboxname: 'SANDBOXNAME'
          scantimeout: 60 # minutes waiting for scan to complete. used for breaking the build
          # exclude: '*.js'
          # include: '*.war'
          criticality: "VeryHigh"
          policy: 'Veracode Recommended Very High + SCA'

  get-policy-flaws:
    if: always()
    needs: policy_scan
    runs-on: ubuntu-latest
    name: Veracode Static Analysis - Get Policy Flaws
    container: veracode/api-signing:latest

    steps:
      - name: Fetch flaws
        run: |
          cd /tmp
          export VERACODE_API_KEY_ID=${{ secrets.VERACODE_API_ID }}
          export VERACODE_API_KEY_SECRET=${{ secrets.VERACODE_API_KEY }}
          guid=$(http --auth-type veracode_hmac GET "https://api.veracode.com/appsec/v1/applications?name=GitHub Actions - python-lets-be-bad-guys" | jq -r '._embedded.applications[0].guid') 
          echo GUID: ${guid}
          total_flaws=$(http --auth-type veracode_hmac GET "https://api.veracode.com/appsec/v2/applications/${guid}/findings?scan_type=STATIC&violates_policy=True" | jq -r '.page.total_elements')
          echo TOTAL_FLAWS: ${total_flaws}
          http --auth-type veracode_hmac GET "https://api.veracode.com/appsec/v2/applications/${guid}/findings?scan_type=STATIC&violates_policy=True&size=${total_flaws}" > policy_flaws.json

      - name: Save results
        uses: actions/upload-artifact@v6
        with:
          name: policy-flaws
          path: /tmp/policy-flaws.json

  results_to_sarif:
    if: always()
    needs: get-policy-flaws
    runs-on: ubuntu-latest
    name: Import policy results to SARIF

    steps:
      - name: Get scan results
        uses: actions/download-artifact@v6
        with:
          name: policy-flaws

      - name: Convert pipeline scan output to SARIF format
        if: always()
        # create code scanning alerts
        uses: veracode/veracode-pipeline-scan-results-to-sarif@master
        with:
          pipeline-results-json: /tmp/policy_flaws.json
          output-results-sarif: veracode-results.sarif
          ref: ${{ github.ref }}
          commitSHA: ${{ github.sha }}
